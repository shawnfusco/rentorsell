<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Calculations</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            background: white;
            padding: 10px 20px 0 20px;
            border-radius: 10px 10px 0 0;
        }
        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
            font-size: 24px;
        }
        .page-title {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .top-section {
            display: grid;
            grid-template-columns: 350px 320px 350px;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            justify-content: center;
        }
        .top-recommendation {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            height: fit-content;
        }
        .control-panel.general {
            border-left: 4px solid #6c757d;
        }
        .control-panel.rental {
            border-left: 4px solid #27ae60;
        }
        .control-panel.selling {
            border-left: 4px solid #3498db;
        }
        .control-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        .control-section:last-child {
            border-bottom: none;
        }
        .control-section h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .slider-group {
            margin-bottom: 8px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-weight: bold;
            color: #34495e;
            font-size: 13px;
        }
        .slider-value {
            color: #3498db;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        /* Red slider for year selection */
        #analysisYears::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
        }
        #analysisYears::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
            border: none;
        }
        .input-group {
            margin-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #34495e;
            font-size: 13px;
        }
        input[type="number"] {
            width: 100%;
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            box-sizing: border-box;
        }
        input[type="number"]:focus {
            border-color: #3498db;
            outline: none;
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 10px;
        }
        .summary-cards {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            align-items: center;
        }
        .chart-only {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .summary-card {
            background: #ecf0f1;
            padding: 25px 20px;
            border-radius: 10px;
            text-align: center;
            border-top: 5px solid #6c757d;
            min-width: 320px;
        }
        .summary-card.better {
            background: #e8f5e8;
        }
        .summary-card#rentCard {
            border-top-color: #27ae60;
        }
        .summary-card#sellCard {
            border-top-color: #3498db;
        }
        .summary-card#rentCard.better {
            border-top-color: #27ae60;
            background: #e8f5e8;
        }
        .summary-card#sellCard.better {
            border-top-color: #3498db;
            background: #e3f2fd;
        }
        .summary-card h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 19px;
        }
        .summary-value {
            font-size: 30px;
            font-weight: bold;
            color: #2c3e50;
        }
        .recommendation {
            background: #3498db;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            max-width: 320px;
            min-width: 300px;
        }
        .recommendation.rent-better { background: #27ae60; }
        .recommendation.sell-better { background: #3498db; }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #3498db;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #2c3e50;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 1200px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
            }
            .chart-container {
                height: 300px;
            }
        }
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('mortgage')">üè¶ Mortgage Calculator</button>
        <button class="tab-button" onclick="switchTab('rent-sell')">üèòÔ∏è Rent or Sell</button>
        <button class="tab-button" onclick="switchTab('strategy')">üí∞ Payment Strategy</button>
    </div>

    <!-- Tab 1: Rent or Sell -->
    <div id="rent-sell" class="tab-content">
        <div class="container">
            <h1 class="page-title">üèòÔ∏è Rent or Sell Analysis</h1>
            <div style="text-align: center; margin-bottom: 25px; color: #7f8c8d; font-style: italic;">
                Compare keeping and renting your property vs selling and investing the proceeds
            </div>
            
            <!-- Top Section with Summary Cards and Recommendation -->
        <div class="top-section">
            <div class="summary-card" id="rentCard">
                <h4>üèòÔ∏è Keep & Rent</h4>
                <div class="summary-value" id="rentTotal">$0</div>
            </div>
            
            <div id="recommendation" class="recommendation">
                <div id="recommendationText"></div>
                <div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div class="slider-label" style="color: white; font-size: 11px; margin-bottom: 2px;">
                        <span>üìÖ Analysis Year</span>
                        <span class="slider-value" id="yearsValue" style="color: white;">30 years</span>
                    </div>
                    <input type="range" id="analysisYears" min="1" max="30" step="1" value="30" oninput="updateSlider('years', this.value)" style="width: 100%;">
                </div>
            </div>
            
            <div class="summary-card" id="sellCard">
                <h4>üí∞ Sell & Invest</h4>
                <div class="summary-value" id="sellTotal">$0</div>
            </div>
        </div>
        
        <div class="main-layout">
            <!-- Chart Section -->
            <div class="chart-only">
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- Controls Grid Below -->
            <div class="controls-grid">
                <!-- General Settings -->
                <div class="control-panel general">
                    <h3>üè° General Settings</h3>
                    <div class="input-group">
                        <label for="currentValue">Current Market Value ($)</label>
                        <input type="number" id="currentValue" value="227000" min="0" onchange="updateAppreciationFromValues()">
                    </div>
                    <div class="input-group">
                        <label for="originalPurchase">Original Purchase Price ($)</label>
                        <input type="number" id="originalPurchase" value="139000" min="0" onchange="updateAppreciationFromValues()">
                    </div>
                    <div class="input-group">
                        <label for="purchaseYear">Purchase Year</label>
                        <input type="number" id="purchaseYear" value="2018" min="1950" max="2025" onchange="updateAppreciationFromValues()">
                    </div>
                    <div class="control-section">
                        <h3>üìà Property Appreciation</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Historical Appreciation <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Calculated from your actual purchase year and current value. This is what already happened.</span>
                                </span></span>
                                <span class="slider-value" id="historicalAppreciationValue">3.5%</span>
                            </div>
                            <input type="range" id="historicalAppreciation" min="0" max="15" step="0.1" value="3.5" disabled style="opacity: 0.6;">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Future Appreciation <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Your projection for future annual appreciation. Consider market conditions, neighborhood trends, and economic outlook.</span>
                                </span></span>
                                <span class="slider-value" id="futureAppreciationValue">3.0%</span>
                            </div>
                            <input type="range" id="futureAppreciation" min="0" max="8" step="0.1" value="3.0" oninput="updateSlider('futureAppreciation', this.value)">
                        </div>
                    </div>
                    <div class="control-section">
                        <h3>üè¶ Mortgage Information</h3>
                        <div class="input-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="hasMortgage" onchange="toggleMortgageFields()" style="transform: scale(1.2);">
                                <span>Property has existing mortgage</span>
                            </label>
                        </div>
                        <div id="mortgageFields" style="display: none;">
                            <div class="input-group">
                                <label for="remainingBalance">Remaining Mortgage Balance ($)</label>
                                <input type="number" id="remainingBalance" value="0" min="0" onchange="updateCalculation()">
                            </div>
                            <div class="input-group">
                                <label for="monthlyPayment">Monthly Mortgage Payment ($)</label>
                                <input type="number" id="monthlyPayment" value="0" min="0" onchange="updateCalculation()">
                            </div>
                            <div class="input-group">
                                <label for="mortgageRate">Mortgage Interest Rate (%)</label>
                                <input type="number" id="mortgageRate" value="6.25" min="0" max="15" step="0.05" onchange="updateCalculation()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rental Scenario Settings -->
                <div class="control-panel rental">
                    <h3>üèòÔ∏è Rental Scenario</h3>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Monthly Rent</span>
                            <span class="slider-value" id="rentValue">$1,400</span>
                        </div>
                        <input type="range" id="monthlyRent" min="1000" max="4000" step="50" value="1400" oninput="updateSlider('rent', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Rent Growth (Annual)</span>
                            <span class="slider-value" id="rentGrowthValue">3%</span>
                        </div>
                        <input type="range" id="rentGrowth" min="0" max="6" step="0.1" value="3" oninput="updateSlider('rentGrowth', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>HOA Fees (Monthly)</span>
                            <span class="slider-value" id="hoaValue">$0</span>
                        </div>
                        <input type="range" id="hoaFees" min="0" max="800" step="25" value="0" oninput="updateSlider('hoa', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Maintenance (Monthly)</span>
                            <span class="slider-value" id="maintenanceValue">$0</span>
                        </div>
                        <input type="range" id="maintenance" min="0" max="1000" step="50" value="0" oninput="updateSlider('maintenance', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Property Mgmt (%)</span>
                            <span class="slider-value" id="propMgmtValue">0.0%</span>
                        </div>
                        <input type="range" id="propManagement" min="0" max="15" step="0.5" value="0" oninput="updateSlider('propMgmt', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Property Taxes (Annual)</span>
                            <span class="slider-value" id="taxesValue">$3,200</span>
                        </div>
                        <input type="range" id="propertyTaxes" min="1000" max="8000" step="100" value="3200" oninput="updateSlider('taxes', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Insurance (Annual)</span>
                            <span class="slider-value" id="insuranceValue">$1,700</span>
                        </div>
                        <input type="range" id="insurance" min="500" max="3000" step="50" value="1700" oninput="updateSlider('insurance', this.value)">
                    </div>
                    <div class="control-section">
                        <h3>üìä Tax Calculations</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Marginal Tax Rate <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Your highest tax bracket rate. Common federal rates: 22% ($47K-$100K), 24% ($100K-$191K), 32% ($191K-$243K). Add ~3-5% for state taxes if applicable.</span>
                                </span></span>
                                <span class="slider-value" id="marginalTaxValue">24%</span>
                            </div>
                            <input type="range" id="marginalTaxRate" min="0" max="37" step="1" value="24" oninput="updateSlider('marginalTax', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="depreciationBasis">Depreciation Basis ($) <span class="tooltip">‚ÑπÔ∏è
                                <span class="tooltiptext">Usually your current property value. This amount √∑ 27.5 years = annual depreciation deduction. For $175K property = $6,364/year tax deduction.</span>
                            </span></label>
                            <input type="number" id="depreciationBasis" value="175000" min="0" onchange="updateCalculation()" placeholder="Auto-updates with current value">
                        </div>
                    </div>
                </div>

                <!-- Selling Scenario Settings -->
                <div class="control-panel selling">
                    <h3>üí∞ Selling Scenario</h3>
                    
                    <div class="control-section">
                        <h3>üè† Pre-Sale Costs</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Repairs & Staging <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Typical costs: $2K-$15K for repairs, painting, cleaning, staging to maximize sale price.</span>
                                </span></span>
                                <span class="slider-value" id="repairsValue">$5,000</span>
                            </div>
                            <input type="range" id="repairsCosts" min="0" max="25000" step="500" value="5000" oninput="updateSlider('repairs', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Home Inspection <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Pre-listing inspection to identify issues early. Typical cost: $300-$600.</span>
                                </span></span>
                                <span class="slider-value" id="inspectionValue">$450</span>
                            </div>
                            <input type="range" id="inspectionCosts" min="0" max="1000" step="50" value="450" oninput="updateSlider('inspection', this.value)">
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h3>üèòÔ∏è Transaction Costs</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Real Estate Commission <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Typically 5-6% total (2.5-3% each for buyer's and seller's agents). Negotiate for lower rates.</span>
                                </span></span>
                                <span class="slider-value" id="commissionValue">5.5%</span>
                            </div>
                            <input type="range" id="realtorCommission" min="0" max="8" step="0.1" value="5.5" oninput="updateSlider('commission', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Title & Closing Costs <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Title insurance, attorney fees, transfer taxes, recording fees. Usually 1-2% of sale price.</span>
                                </span></span>
                                <span class="slider-value" id="closingValue">1.5%</span>
                            </div>
                            <input type="range" id="closingCosts" min="0.5" max="3" step="0.1" value="1.5" oninput="updateSlider('closing', this.value)">
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h3>üìä Taxes & Investment</h3>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Capital Gains Tax <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Real estate: 0% (primary residence), 15% (most people), 20% (high income), 25% (depreciation recapture). Add 3-13% state taxes.</span>
                                </span></span>
                                <span class="slider-value" id="capitalGainsValue">15%</span>
                            </div>
                            <input type="range" id="capitalGainsRate" min="0" max="35" step="1" value="15" oninput="updateSlider('capitalGains', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Investment Return (Annual) <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">S&P 500 historical: 10-11%. Conservative: 6-7%. Aggressive: 8-10%. Consider fees, taxes, and volatility.</span>
                                </span></span>
                                <span class="slider-value" id="investmentValue">7.5%</span>
                            </div>
                            <input type="range" id="investmentReturn" min="4" max="12" step="0.1" value="7.5" oninput="updateSlider('investment', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Investment Tax Rate <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Tax on investment gains/dividends. 0% (low income), 15% (most people), 20% (high income). Consider tax-advantaged accounts.</span>
                                </span></span>
                                <span class="slider-value" id="investmentTaxValue">15%</span>
                            </div>
                            <input type="range" id="investmentTaxRate" min="0" max="25" step="1" value="15" oninput="updateSlider('investmentTax', this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Tab 2: Mortgage Payment Calculator -->
    <div id="mortgage" class="tab-content active">
    <!-- Mortgage Payment Calculator -->
    <div class="container" style="margin-top: 20px;">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 20px;">üè¶ Mortgage Payment Calculator</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
            <!-- Input Section -->
            <div class="control-panel" style="border-left: 4px solid #e67e22;">
                <h3>üí∞ Loan Details</h3>
                <div class="input-group">
                    <label for="loanAmount">Loan Amount ($)</label>
                    <input type="number" id="loanAmount" value="431000" min="0" onchange="calculateMortgage()" placeholder="Amount to borrow">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Interest Rate (Annual)</span>
                        <span class="slider-value" id="mortgageInterestValue">6.25%</span>
                    </div>
                    <input type="range" id="mortgageInterestRate" min="2" max="10" step="0.05" value="6.25" oninput="updateMortgageSlider('mortgageInterest', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Loan Term</span>
                        <span class="slider-value" id="loanTermValue">30 years</span>
                    </div>
                    <input type="range" id="loanTerm" min="10" max="30" step="5" value="30" oninput="updateMortgageSlider('loanTerm', this.value)">
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="control-panel" style="border-left: 4px solid #27ae60;">
                <h3>üìä Payment Breakdown</h3>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold;">Monthly Payment:</span>
                        <span id="monthlyPaymentResult" style="font-size: 18px; font-weight: bold; color: #2c3e50;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Principal & Interest:</span>
                        <span id="principalInterestResult" style="color: #2c3e50;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Interest Paid:</span>
                        <span id="totalInterestResult" style="color: #e74c3c;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Amount Paid:</span>
                        <span id="totalAmountResult" style="color: #2c3e50;">$0</span>
                    </div>
                </div>
                <button onclick="copyToMortgageFields()" style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    üìã Copy to Mortgage Fields in Rent or Sell Tab
                </button>
            </div>
        </div>
    </div>

    <!-- Effective Interest Rate Calculator -->
    <div class="container" style="margin-top: 20px;">
        <h2 style="color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 20px;">üíµ Extra Payment Analysis & Effective Interest Rate</h2>
        
        <div style="display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; align-items: start;">
            <!-- Extra Payment Input -->
            <div class="control-panel" style="border-left: 4px solid #9b59b6;">
                <h3>üí∞ Extra Monthly Payment</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Extra Payment Amount <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Additional amount you pay each month beyond the required payment. This goes directly to principal and reduces total interest paid.</span>
                        </span></span>
                        <span class="slider-value" id="extraPaymentValue">$0</span>
                    </div>
                    <input type="range" id="extraPayment" min="0" max="3000" step="50" value="0" oninput="updateExtraPayment(this.value)">
                </div>
                
                <div style="margin: 20px 0; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #3498db; font-size: 14px;">üéØ Or Target an Effective Rate</div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Target Effective Rate <span class="tooltip">‚ÑπÔ∏è
                                <span class="tooltiptext">Set your desired effective interest rate. The extra payment slider above will automatically adjust to achieve this rate.</span>
                            </span></span>
                            <span class="slider-value" id="targetRateValue">6.50%</span>
                        </div>
                        <input type="range" id="targetRate" min="0.5" max="10" step="0.05" value="6.5" oninput="updateTargetRate(this.value)">
                    </div>
                    <div id="targetRateWarning" style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 5px; border-left: 3px solid #2196f3; display: none; font-size: 12px;">
                        <span style="color: #1565c0;"></span>
                    </div>
                </div>
                
                <div style="margin: 20px 0; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #e67e22; font-size: 14px;">üíµ One-Time Lump Sum Payment</div>
                    <div class="input-group">
                        <label for="lumpSumAmount">Lump Sum Amount ($) <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">A one-time extra payment you plan to make towards principal at a specific month.</span>
                        </span></label>
                        <input type="number" id="lumpSumAmount" value="0" min="0" step="1000" onchange="calculateEffectiveRate()" placeholder="e.g., 10000">
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <label for="lumpSumMonth">Payment Month <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">The month number when you'll make this lump sum payment (e.g., month 12 = 1 year, month 60 = 5 years).</span>
                        </span></label>
                        <input type="number" id="lumpSumMonth" value="12" min="1" max="360" onchange="calculateEffectiveRate()" oninput="calculateEffectiveRate()" placeholder="e.g., 12">
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px;">New Monthly Payment:</span>
                        <span id="totalMonthlyPayment" style="font-weight: bold; color: #2c3e50;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px; color: #7f8c8d;">Payment Multiplier:</span>
                        <span id="paymentMultiplier" style="font-weight: bold; color: #9b59b6;">1.0x</span>
                    </div>
                </div>
            </div>
            
            <!-- Loan Balance Chart -->
            <div class="control-panel" style="border-left: 4px solid #3498db;">
                <h3>üìà Loan Balance Over Time</h3>
                <div style="position: relative; height: 400px;">
                    <canvas id="loanBalanceChart"></canvas>
                </div>
            </div>
            
            <!-- Comparison Results -->
            <div class="control-panel" style="border-left: 4px solid #e67e22;">
                <h3>üìä Impact Comparison</h3>
                <div style="background: #fff; padding: 12px; border-radius: 5px; border: 2px solid #ecf0f1; margin-bottom: 12px;">
                    <div style="text-align: center; margin-bottom: 8px; color: #7f8c8d; font-size: 12px; font-weight: bold;">STANDARD LOAN</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px;">Payoff Time:</span>
                        <span id="standardPayoffTime" style="font-weight: bold;">0 years</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px;">Total Interest:</span>
                        <span id="standardTotalInterest" style="font-weight: bold; color: #e74c3c;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px;">Nominal Rate:</span>
                        <span id="standardRate" style="font-weight: bold;">0.0%</span>
                    </div>
                </div>
                <div style="background: #e8f5e9; padding: 12px; border-radius: 5px; border: 2px solid #27ae60;">
                    <div style="text-align: center; margin-bottom: 8px; color: #27ae60; font-size: 12px; font-weight: bold;">WITH EXTRA PAYMENTS</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px;">Payoff Time:</span>
                        <span id="extraPayoffTime" style="font-weight: bold; color: #27ae60;">0 years</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px;">Total Interest:</span>
                        <span id="extraTotalInterest" style="font-weight: bold; color: #27ae60;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px;">Effective Rate:</span>
                        <span id="effectiveRate" style="font-weight: bold; font-size: 16px; color: #27ae60;">0.0%</span>
                    </div>
                </div>
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 12px; border: 2px solid #ffc107;">
                    <div style="text-align: center; margin-bottom: 5px; color: #856404; font-size: 12px; font-weight: bold;">üí∞ SAVINGS</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 12px;">Time Saved:</span>
                        <span id="timeSaved" style="font-weight: bold; color: #856404;">0 years</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px;">Interest Saved:</span>
                        <span id="interestSaved" style="font-weight: bold; font-size: 16px; color: #856404;">$0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
            <div style="font-weight: bold; margin-bottom: 5px; color: #1976d2;">üìù What is "Effective Interest Rate"?</div>
            <div style="font-size: 13px; color: #34495e; line-height: 1.5;">
                The effective interest rate shows what your <strong>actual</strong> borrowing cost becomes when making extra payments. 
                While your nominal rate stays the same (e.g., 6.25%), paying extra reduces the total interest you pay over the life of the loan. 
                The effective rate calculates what interest rate on the original loan would have resulted in the same total interest 
                you'll actually pay with your accelerated payment schedule. Lower is better!
            </div>
        </div>
    </div>
    </div>

    <!-- Tab 3: Down Payment vs Extra Payment Strategy -->
    <div id="strategy" class="tab-content">
    <!-- Down Payment vs Extra Payment Strategy Calculator -->
    <div class="container" style="margin-top: 30px;">
        <h1 class="page-title">üí∞ Down Payment vs Extra Payment Strategy w/Interest Rate Buydown</h1>
        <div style="text-align: center; margin-bottom: 25px; color: #7f8c8d; font-style: italic;">
            Compare putting more money down vs keeping cash for extra monthly payments
        </div>

        <!-- Strategy Comparison Charts -->
        <div style="margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db;">
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <h4 style="margin-top: 0; color: #2c3e50; font-size: 14px;">üìâ Loan Balance Over Time</h4>
                <canvas id="strategyBalanceChart" style="max-height: 250px;"></canvas>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <h4 style="margin-top: 0; color: #2c3e50; font-size: 14px;">üí∞ Cumulative Cost (Today's $)</h4>
                <canvas id="strategyCostChart" style="max-height: 250px;"></canvas>
            </div>
        </div>

        <div class="controls-grid">
            <!-- Strategy Inputs -->
            <div class="control-panel" style="border-left: 4px solid #9b59b6;">
                <h3>üéØ Strategy Comparison Inputs</h3>
                
                <div class="control-section">
                    <div class="input-group">
                        <label for="strategyHomePrice">Home Purchase Price ($)</label>
                        <input type="number" id="strategyHomePrice" value="428000" min="0" step="1000" oninput="calculateStrategyComparison()" placeholder="e.g., 428000">
                    </div>
                    <div class="input-group">
                        <label for="strategyInterestRate">Interest Rate (%)</label>
                        <input type="number" id="strategyInterestRate" value="5.35" min="0" max="20" step="0.01" oninput="calculateStrategyComparison()" placeholder="e.g., 5.35">
                    </div>
                    <div class="input-group">
                        <label for="strategyLoanTerm">Loan Term (years)</label>
                        <input type="number" id="strategyLoanTerm" value="30" min="10" max="40" step="1" oninput="calculateStrategyComparison()" placeholder="e.g., 30">
                    </div>
                    <div class="input-group">
                        <label for="availableCash">Available Extra Cash ($) <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">The additional money you have to either put down or use for extra payments</span>
                        </span></label>
                        <input type="number" id="availableCash" value="50000" min="0" step="1000" oninput="calculateStrategyComparison()" placeholder="e.g., 50000">
                    </div>
                    <div class="input-group">
                        <label for="baseDownPayment">Base Down Payment ($) <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Your minimum down payment before using extra cash</span>
                        </span></label>
                        <input type="number" id="baseDownPayment" value="0" min="0" step="1000" oninput="calculateStrategyComparison()" placeholder="e.g., 0">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Expected Inflation Rate (%) <span class="tooltip">‚ÑπÔ∏è
                                <span class="tooltiptext">Annual inflation rate to adjust future payments to today's purchasing power. Historical average is ~3%</span>
                            </span></span>
                            <span id="inflationRateValue">3.0%</span>
                        </div>
                        <input type="range" id="inflationRate" min="0" max="8" step="0.1" value="3.0" oninput="updateInflationRateDisplay(); calculateStrategyComparison()">
                    </div>
                </div>
            </div>

            <!-- Strategy A Results -->
            <div class="control-panel" style="border-left: 4px solid #e74c3c;">
                <h3>üè† Strategy A: Larger Down Payment</h3>
                
                <div style="background: #ffe6e6; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #c0392b; margin-bottom: 6px; font-size: 12px;">üéöÔ∏è Rate Adjustment</div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span style="font-size: 11px;">Rate Adjustment (%):</span>
                            <span id="strategyARateAdjustmentValue" style="font-size: 11px;">0.00%</span>
                        </div>
                        <input type="range" id="strategyARateAdjustment" min="-2" max="0" step="0.125" value="0" oninput="updateStrategyARateDisplay(); calculateStrategyComparison()">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span style="font-size: 11px;">Buydown Cost ($):</span>
                            <span id="strategyABuydownCostValue" style="font-size: 11px;">$0</span>
                        </div>
                        <input type="range" id="strategyABuydownCost" min="0" max="20000" step="500" value="0" oninput="updateStrategyARateDisplay(); calculateStrategyComparison()">
                    </div>
                    <div style="font-size: 10px; color: #7f8c8d; margin-top: 4px; font-style: italic;">
                        Adjusted Rate: <span id="strategyAEffectiveRate" style="font-weight: bold; color: #c0392b;">5.35%</span>
                    </div>
                </div>
                
                <div style="background: #fff5f5; padding: 12px; border-radius: 5px; margin-bottom: 12px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 8px;">üìä Loan Details</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Nominal Interest Rate:</span>
                        <span id="strategyAEffectiveRateDisplay" style="font-weight: bold; color: #7f8c8d;">5.35%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px; padding-bottom: 3px; border-bottom: 1px solid #dee2e6;">
                        <span style="font-size: 12px; font-weight: bold;">Effective Interest Rate <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">The actual borrowing cost. For Strategy A without extra payments, this equals the nominal rate.</span>
                        </span>:</span>
                        <span id="strategyAActualEffectiveRate" style="font-weight: bold; color: #e74c3c; font-size: 14px;">5.35%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Down Payment:</span>
                        <span id="strategyADownPayment" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Loan Amount:</span>
                        <span id="strategyALoanAmount" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Base Monthly Payment:</span>
                        <span id="strategyABasePayment" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Extra Monthly Payment:</span>
                        <span id="strategyAExtraPayment" style="font-weight: bold; color: #7f8c8d;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px;">Total Monthly Payment:</span>
                        <span id="strategyATotalPayment" style="font-weight: bold;">$0</span>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">üí∏ Total Costs</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Total Interest:</span>
                        <span id="strategyATotalInterest" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Total Payments:</span>
                        <span id="strategyATotalPayments" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Total Cost (Nominal):</span>
                        <span id="strategyATotalCost" style="font-weight: bold; color: #e74c3c;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; border-top: 1px solid #dee2e6; padding-top: 3px;">
                        <span style="font-size: 12px; font-weight: bold;">Total Cost (Today's $):</span>
                        <span id="strategyATotalCostReal" style="font-weight: bold; color: #e74c3c;">$0</span>
                    </div>
                </div>
            </div>

            <!-- Strategy B Results -->
            <div class="control-panel" style="border-left: 4px solid #27ae60;">
                <h3>üíµ Strategy B: Extra Monthly Payments</h3>
                
                <div style="background: #e6ffe6; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #1e7e34; margin-bottom: 6px; font-size: 12px;">üéöÔ∏è Rate Adjustment</div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span style="font-size: 11px;">Rate Adjustment (%):</span>
                            <span id="strategyBRateAdjustmentValue" style="font-size: 11px;">0.00%</span>
                        </div>
                        <input type="range" id="strategyBRateAdjustment" min="-2" max="0" step="0.125" value="0" oninput="updateStrategyBRateDisplay(); calculateStrategyComparison()">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span style="font-size: 11px;">Buydown Cost ($):</span>
                            <span id="strategyBBuydownCostValue" style="font-size: 11px;">$0</span>
                        </div>
                        <input type="range" id="strategyBBuydownCost" min="0" max="20000" step="500" value="0" oninput="updateStrategyBRateDisplay(); calculateStrategyComparison()">
                    </div>
                    <div style="font-size: 10px; color: #7f8c8d; margin-top: 4px; font-style: italic;">
                        Adjusted Rate: <span id="strategyBEffectiveRate" style="font-weight: bold; color: #1e7e34;">5.35%</span>
                    </div>
                </div>
                
                <div style="background: #f8fff9; padding: 12px; border-radius: 5px; margin-bottom: 12px;">
                    <div style="font-weight: bold; color: #27ae60; margin-bottom: 8px;">üìä Loan Details</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Nominal Interest Rate:</span>
                        <span id="strategyBEffectiveRateDisplay" style="font-weight: bold; color: #7f8c8d;">5.35%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px; padding-bottom: 3px; border-bottom: 1px solid #dee2e6;">
                        <span style="font-size: 12px; font-weight: bold;">Effective Interest Rate <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">The actual borrowing cost when making extra payments. Shows what rate would result in the same total interest on a standard loan.</span>
                        </span>:</span>
                        <span id="strategyBActualEffectiveRate" style="font-weight: bold; color: #27ae60; font-size: 14px;">5.35%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Down Payment:</span>
                        <span id="strategyBDownPayment" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Loan Amount:</span>
                        <span id="strategyBLoanAmount" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Base Monthly Payment:</span>
                        <span id="strategyBBasePayment" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Extra Monthly Payment:</span>
                        <span id="strategyBExtraPayment" style="font-weight: bold; color: #27ae60;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 12px;">Total Monthly Payment:</span>
                        <span id="strategyBTotalPayment" style="font-weight: bold;">$0</span>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">üí∏ Total Costs</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Total Interest:</span>
                        <span id="strategyBTotalInterest" style="font-weight: bold;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Payoff Time:</span>
                        <span id="strategyBPayoffTime" style="font-weight: bold;">0 years</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="font-size: 12px;">Total Cost (Nominal):</span>
                        <span id="strategyBTotalCost" style="font-weight: bold; color: #27ae60;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; border-top: 1px solid #dee2e6; padding-top: 3px;">
                        <span style="font-size: 12px; font-weight: bold;">Total Cost (Today's $):</span>
                        <span id="strategyBTotalCostReal" style="font-weight: bold; color: #27ae60;">$0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Results -->
        <div style="margin-top: 20px; background: #f8f9fa; border-radius: 10px; padding: 20px; border-left: 4px solid #3498db;">
            <h3 style="color: #3498db; margin-top: 0;">üéØ Strategy Comparison Results</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">INTEREST DIFFERENCE</div>
                    <div id="interestDifference" style="font-size: 18px; font-weight: bold;">$0</div>
                    <div id="interestDifferenceNote" style="font-size: 11px; margin-top: 3px;"></div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">TOTAL COST DIFFERENCE (Nominal)</div>
                    <div id="totalCostDifference" style="font-size: 18px; font-weight: bold;">$0</div>
                    <div id="totalCostDifferenceNote" style="font-size: 11px; margin-top: 3px;"></div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">REAL COST DIFFERENCE (Today's $)</div>
                    <div id="realCostDifference" style="font-size: 18px; font-weight: bold;">$0</div>
                    <div id="realCostDifferenceNote" style="font-size: 11px; margin-top: 3px;"></div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">INFLATION IMPACT</div>
                    <div id="inflationImpact" style="font-size: 18px; font-weight: bold;">$0</div>
                    <div id="inflationImpactNote" style="font-size: 11px; margin-top: 3px;"></div>
                </div>
            </div>

            <div id="strategyRecommendation" style="padding: 12px; border-radius: 8px; font-weight: bold; text-align: center;">
                Enter values to see recommendation
            </div>
        </div>

        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
            <div style="font-weight: bold; margin-bottom: 5px; color: #1976d2;">üìù Strategy Notes & Inflation Impact</div>
            <div style="font-size: 13px; color: #34495e; line-height: 1.5;">
                <strong>Strategy A</strong> uses all extra cash as down payment for lower monthly payments.<br>
                <strong>Strategy B</strong> keeps the minimum down payment and spreads extra cash over monthly payments.<br><br>
                
                <strong>üí∞ Inflation Consideration:</strong> Future payments are worth less than today's money. At 3% inflation, $1000 in year 30 only has the buying power of ~$400 today! This is why "Today's $" calculations are more meaningful - they show what everything costs in current purchasing power.<br><br>
                
                <strong>Key Insight:</strong> The longer the loan term, the more inflation helps borrowers. Strategy A (30 years) vs Strategy B (shorter term) - inflation benefits the longer loan more, which can change the comparison significantly.
            </div>
        </div>
    </div>

    <script>
        let chart;
        let loanBalanceChart;
        let strategyBalanceChart;
        let strategyCostChart;
        
        function calculateAppreciationRate() {
            const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
            const originalPurchase = parseFloat(document.getElementById('originalPurchase').value) || 0;
            const purchaseYear = parseInt(document.getElementById('purchaseYear').value) || 2005;
            
            if (currentValue <= 0 || originalPurchase <= 0 || currentValue <= originalPurchase) {
                return 3.5; // Default fallback
            }
            
            // Calculate years owned from purchase year to current year (2025)
            const currentYear = 2025;
            const yearsOwned = currentYear - purchaseYear;
            
            if (yearsOwned <= 0) {
                return 3.5; // Fallback for invalid years
            }
            
            // Calculate compound annual growth rate (CAGR)
            const appreciationRate = (Math.pow(currentValue / originalPurchase, 1 / yearsOwned) - 1) * 100;
            
            // Cap between reasonable bounds (0-8%)
            return Math.min(Math.max(appreciationRate, 0), 8);
        }
        
        function updateAppreciationFromValues() {
            const calculatedRate = calculateAppreciationRate();
            const roundedRate = Math.round(calculatedRate * 10) / 10; // Round to 1 decimal
            const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
            
            // Update historical appreciation (calculated, read-only)
            document.getElementById('historicalAppreciation').value = roundedRate;
            document.getElementById('historicalAppreciationValue').textContent = roundedRate.toFixed(1) + '%';
            
            // Update depreciation basis to current market value
            document.getElementById('depreciationBasis').value = currentValue;
            
            updateCalculation();
        }
        
        function toggleMortgageFields() {
            const hasMortgage = document.getElementById('hasMortgage').checked;
            const mortgageFields = document.getElementById('mortgageFields');
            
            if (hasMortgage) {
                mortgageFields.style.display = 'block';
            } else {
                mortgageFields.style.display = 'none';
            }
            
            updateCalculation();
        }
        
        // Mortgage Calculator Functions
        function updateMortgageSlider(type, value) {
            switch(type) {
                case 'mortgageInterest':
                    document.getElementById('mortgageInterestValue').textContent = parseFloat(value).toFixed(2) + '%';
                    break;
                case 'loanTerm':
                    document.getElementById('loanTermValue').textContent = parseInt(value) + ' years';
                    break;
            }
            calculateMortgage();
        }
        
        function calculateMortgage() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const annualRate = parseFloat(document.getElementById('mortgageInterestRate').value) || 0;
            const loanTermYears = parseInt(document.getElementById('loanTerm').value) || 30;
            
            if (loanAmount <= 0 || annualRate <= 0) {
                document.getElementById('monthlyPaymentResult').textContent = '$0';
                document.getElementById('principalInterestResult').textContent = '$0';
                document.getElementById('totalInterestResult').textContent = '$0';
                document.getElementById('totalAmountResult').textContent = '$0';
                return;
            }
            
            // Calculate monthly payment using standard mortgage formula
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = loanTermYears * 12;
            
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                 (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            const totalAmount = monthlyPayment * numPayments;
            const totalInterest = totalAmount - loanAmount;
            
            // Update display
            document.getElementById('monthlyPaymentResult').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
            document.getElementById('principalInterestResult').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
            document.getElementById('totalInterestResult').textContent = '$' + Math.round(totalInterest).toLocaleString();
            document.getElementById('totalAmountResult').textContent = '$' + Math.round(totalAmount).toLocaleString();
            
            // Update target rate slider to match current rate
            document.getElementById('targetRate').value = annualRate;
            document.getElementById('targetRateValue').textContent = annualRate.toFixed(2) + '%';
            
            // Update effective interest rate calculator
            calculateEffectiveRate();
        }
        
        function updateExtraPayment(value) {
            document.getElementById('extraPaymentValue').textContent = '$' + parseInt(value).toLocaleString();
            calculateEffectiveRate();
            
            // Update the target rate slider to match the achieved effective rate
            const effectiveRateText = document.getElementById('effectiveRate').textContent;
            const effectiveRateValue = parseFloat(effectiveRateText.replace('%', '')) || 0;
            
            if (effectiveRateValue > 0) {
                document.getElementById('targetRate').value = effectiveRateValue;
                document.getElementById('targetRateValue').textContent = effectiveRateValue.toFixed(2) + '%';
            }
        }
        
        function calculateEffectiveRate() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const annualRate = parseFloat(document.getElementById('mortgageInterestRate').value) || 0;
            const loanTermYears = parseInt(document.getElementById('loanTerm').value) || 30;
            const extraPayment = parseFloat(document.getElementById('extraPayment').value) || 0;
            const lumpSumAmount = parseFloat(document.getElementById('lumpSumAmount').value) || 0;
            const lumpSumMonth = parseInt(document.getElementById('lumpSumMonth').value) || 12;
            
            if (loanAmount <= 0 || annualRate <= 0) {
                // Reset displays
                document.getElementById('totalMonthlyPayment').textContent = '$0';
                document.getElementById('paymentMultiplier').textContent = '1.0x';
                document.getElementById('standardPayoffTime').textContent = '0 years';
                document.getElementById('standardTotalInterest').textContent = '$0';
                document.getElementById('standardRate').textContent = '0.0%';
                document.getElementById('extraPayoffTime').textContent = '0 years';
                document.getElementById('extraTotalInterest').textContent = '$0';
                document.getElementById('effectiveRate').textContent = '0.0%';
                document.getElementById('timeSaved').textContent = '0 years';
                document.getElementById('interestSaved').textContent = '$0';
                return;
            }
            
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = loanTermYears * 12;
            
            // Calculate standard monthly payment
            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                 (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            // Standard loan calculations
            const standardTotalInterest = (monthlyPayment * numPayments) - loanAmount;
            const standardPayoffMonths = numPayments;
            
            // Update standard loan display
            document.getElementById('standardPayoffTime').textContent = formatMonthsToYears(standardPayoffMonths);
            document.getElementById('standardTotalInterest').textContent = '$' + Math.round(standardTotalInterest).toLocaleString();
            document.getElementById('standardRate').textContent = annualRate.toFixed(2) + '%';
            
            // Calculate with extra payments
            const totalPayment = monthlyPayment + extraPayment;
            document.getElementById('totalMonthlyPayment').textContent = '$' + Math.round(totalPayment).toLocaleString();
            
            const multiplier = monthlyPayment > 0 ? totalPayment / monthlyPayment : 1.0;
            document.getElementById('paymentMultiplier').textContent = multiplier.toFixed(2) + 'x';
            
            // Simulate loan payoff with extra payments and lump sum
            let balance = loanAmount;
            let totalInterestWithExtra = 0;
            let monthsWithExtra = 0;
            
            while (balance > 0 && monthsWithExtra < numPayments * 2) { // Safety limit
                monthsWithExtra++;
                
                const interestPayment = balance * monthlyRate;
                let principalPayment = totalPayment - interestPayment;
                
                // Apply lump sum payment at specified month
                if (monthsWithExtra === lumpSumMonth && lumpSumAmount > 0) {
                    principalPayment += lumpSumAmount;
                }
                
                totalInterestWithExtra += interestPayment;
                balance -= principalPayment;
                
                if (balance <= 0) break;
            }
            
            // Update extra payment display
            document.getElementById('extraPayoffTime').textContent = formatMonthsToYears(monthsWithExtra);
            document.getElementById('extraTotalInterest').textContent = '$' + Math.round(totalInterestWithExtra).toLocaleString();
            
            // Calculate effective interest rate
            // Method 1: Simple average annual interest cost as % of principal
            const yearsWithExtra = monthsWithExtra / 12;
            const averageAnnualInterest = totalInterestWithExtra / yearsWithExtra;
            const simpleEffectiveRate = (averageAnnualInterest / loanAmount) * 100;
            
            // Method 2: More accurate - what rate on the original term would give this total interest
            // We'll use the original loan term to make the comparison more meaningful
            const effectiveAnnualRate = calculateEffectiveAnnualRate(loanAmount, totalInterestWithExtra, loanTermYears);
            
            // Use Method 2 as it's more accurate and comparable to the nominal rate
            document.getElementById('effectiveRate').textContent = effectiveAnnualRate.toFixed(2) + '%';
            
            // Update the target rate slider to match the calculated effective rate
            const targetRateSlider = document.getElementById('targetRate');
            const targetRateValue = document.getElementById('targetRateValue');
            if (targetRateSlider && targetRateValue) {
                targetRateSlider.value = effectiveAnnualRate.toFixed(2);
                targetRateValue.textContent = effectiveAnnualRate.toFixed(2) + '%';
            }
            
            // Calculate savings
            const monthsSaved = standardPayoffMonths - monthsWithExtra;
            const interestSaved = standardTotalInterest - totalInterestWithExtra;
            
            document.getElementById('timeSaved').textContent = formatMonthsToYears(monthsSaved);
            document.getElementById('interestSaved').textContent = '$' + Math.round(interestSaved).toLocaleString();
            
            // Update loan balance chart
            updateLoanBalanceChart(loanAmount, monthlyRate, monthlyPayment, totalPayment, standardPayoffMonths, monthsWithExtra, lumpSumAmount, lumpSumMonth);
        }
        
        function updateLoanBalanceChart(loanAmount, monthlyRate, standardPayment, extraPayment, standardMonths, extraMonths, lumpSumAmount, lumpSumMonth) {
            const ctx = document.getElementById('loanBalanceChart').getContext('2d');
            
            // Generate data for both scenarios
            const maxMonths = Math.max(standardMonths, extraMonths);
            const months = [];
            const standardBalances = [];
            const extraBalances = [];
            const standardInterest = [];
            const extraInterest = [];
            
            // Calculate standard loan balance and cumulative interest over time
            let standardBalance = loanAmount;
            let standardCumulativeInterest = 0;
            for (let month = 0; month <= maxMonths; month++) {
                months.push(month);
                standardBalances.push(Math.max(0, standardBalance));
                standardInterest.push(standardCumulativeInterest);
                
                if (standardBalance > 0 && month < standardMonths) {
                    const interest = standardBalance * monthlyRate;
                    const principal = standardPayment - interest;
                    standardBalance -= principal;
                    standardCumulativeInterest += interest;
                }
            }
            
            // Calculate extra payment loan balance and cumulative interest over time (with lump sum)
            let extraBalance = loanAmount;
            let extraCumulativeInterest = 0;
            for (let month = 0; month <= maxMonths; month++) {
                extraBalances.push(Math.max(0, extraBalance));
                extraInterest.push(extraCumulativeInterest);
                
                if (extraBalance > 0 && month < extraMonths) {
                    const interest = extraBalance * monthlyRate;
                    let principal = extraPayment - interest;
                    
                    // Apply lump sum payment at specified month
                    if (month === lumpSumMonth && lumpSumAmount > 0) {
                        principal += lumpSumAmount;
                    }
                    
                    extraBalance -= principal;
                    extraCumulativeInterest += interest;
                }
            }
            
            // Convert months to years for x-axis
            const years = months.map(m => m / 12);
            
            if (loanBalanceChart) {
                loanBalanceChart.destroy();
            }
            
            loanBalanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Standard Balance',
                        data: standardBalances,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        borderDash: [], // Explicitly set as solid line
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Extra Payment Balance',
                        data: extraBalances,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: extraBalances.map((_, i) => i === lumpSumMonth && lumpSumAmount > 0 ? 6 : 0),
                        pointBackgroundColor: extraBalances.map((_, i) => i === lumpSumMonth && lumpSumAmount > 0 ? '#e67e22' : '#27ae60'),
                        pointBorderColor: extraBalances.map((_, i) => i === lumpSumMonth && lumpSumAmount > 0 ? '#d35400' : '#27ae60'),
                        pointBorderWidth: 2,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Standard Interest Paid',
                        data: standardInterest,
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Extra Payment Interest Paid',
                        data: extraInterest,
                        borderColor: '#16a085',
                        backgroundColor: 'rgba(22, 160, 133, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 8,
                                font: {
                                    size: 11
                                },
                                usePointStyle: false,
                                boxWidth: 20,
                                boxHeight: 2
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const years = tooltipItems[0].parsed.x;
                                    const months = Math.round(years * 12);
                                    const y = Math.floor(months / 12);
                                    const m = months % 12;
                                    
                                    // Check if this is the lump sum month
                                    if (months === lumpSumMonth && lumpSumAmount > 0) {
                                        return `Month ${months} (${y}y ${m}m) üí∞ LUMP SUM: $${Math.round(lumpSumAmount).toLocaleString()}`;
                                    }
                                    return `Month ${months} (${y}y ${m}m)`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: $${Math.round(value).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years',
                                font: {
                                    size: 11
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return value.toFixed(0);
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount ($)',
                                font: {
                                    size: 11
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function calculateEffectiveAnnualRate(principal, totalInterest, years) {
            // Calculate the effective rate using the actual interest paid and time period
            // This approximates what the annual rate would be if we paid this much interest
            // over this time period
            
            if (years <= 0 || principal <= 0) return 0;
            
            // Use iterative approach to find the rate that produces the observed interest
            // Start with a reasonable guess and refine
            let low = 0;
            let high = 20; // Max 20% rate for search
            let testRate = (low + high) / 2;
            const tolerance = 0.01; // 0.01% accuracy
            let iterations = 0;
            const maxIterations = 50;
            
            while (iterations < maxIterations && (high - low) > tolerance) {
                const monthlyRate = testRate / 100 / 12;
                const numPayments = years * 12;
                
                // Calculate what monthly payment would be needed at this rate
                const testPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                   (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                const testTotalInterest = (testPayment * numPayments) - principal;
                
                if (Math.abs(testTotalInterest - totalInterest) < 100) {
                    // Close enough
                    return testRate;
                } else if (testTotalInterest > totalInterest) {
                    // Test rate is too high
                    high = testRate;
                } else {
                    // Test rate is too low
                    low = testRate;
                }
                
                testRate = (low + high) / 2;
                iterations++;
            }
            
            return testRate;
        }
        
        function formatMonthsToYears(months) {
            if (months === 0) return '0 years';
            
            const years = Math.floor(months / 12);
            const remainingMonths = Math.round(months % 12);
            
            if (years === 0) {
                return remainingMonths + ' month' + (remainingMonths !== 1 ? 's' : '');
            } else if (remainingMonths === 0) {
                return years + ' year' + (years !== 1 ? 's' : '');
            } else {
                return years + 'y ' + remainingMonths + 'm';
            }
        }
        
        function updateTargetRate(value) {
            document.getElementById('targetRateValue').textContent = parseFloat(value).toFixed(2) + '%';
            
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const annualRate = parseFloat(document.getElementById('mortgageInterestRate').value) || 0;
            const loanTermYears = parseInt(document.getElementById('loanTerm').value) || 30;
            const targetRate = parseFloat(value) || 0;
            
            if (loanAmount <= 0 || annualRate <= 0) {
                document.getElementById('targetRateWarning').style.display = 'none';
                return;
            }
            
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = loanTermYears * 12;
            
            // Calculate standard monthly payment
            const standardPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                   (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            // Check if target rate is already higher than or equal to current rate
            if (targetRate >= annualRate) {
                document.getElementById('extraPayment').value = 0;
                document.getElementById('extraPaymentValue').textContent = '$0';
                document.getElementById('targetRateWarning').style.display = 'block';
                document.getElementById('targetRateWarning').style.background = '#e3f2fd';
                document.getElementById('targetRateWarning').style.borderLeft = '3px solid #2196f3';
                
                if (Math.abs(targetRate - annualRate) < 0.01) {
                    // Exactly at nominal rate
                    document.getElementById('targetRateWarning').querySelector('span').innerHTML = 
                        '‚úì This is your current nominal rate. No extra payments needed - this is the standard loan payment.';
                    document.getElementById('targetRateWarning').querySelector('span').style.color = '#1565c0';
                } else {
                    // Above nominal rate
                    document.getElementById('targetRateWarning').querySelector('span').innerHTML = 
                        '‚ö†Ô∏è Target rate is higher than your nominal rate. This is not achievable - you cannot make the loan more expensive by paying extra.';
                    document.getElementById('targetRateWarning').querySelector('span').style.color = '#1565c0';
                }
                calculateEffectiveRate();
                return;
            }
            
            // Calculate target total interest based on effective rate
            const targetMonthlyRate = targetRate / 100 / 12;
            const targetPayment = loanAmount * (targetMonthlyRate * Math.pow(1 + targetMonthlyRate, numPayments)) / 
                                (Math.pow(1 + targetMonthlyRate, numPayments) - 1);
            const targetTotalInterest = (targetPayment * numPayments) - loanAmount;
            
            // Use binary search to find the required extra payment
            let low = 0;
            let high = loanAmount; // Maximum reasonable extra payment
            let requiredExtraPayment = 0;
            const tolerance = 1; // $1 tolerance
            let iterations = 0;
            const maxIterations = 100;
            
            while (iterations < maxIterations && (high - low) > tolerance) {
                const testExtra = (low + high) / 2;
                const testPayment = standardPayment + testExtra;
                
                // Simulate loan with this payment
                let balance = loanAmount;
                let totalInterest = 0;
                let months = 0;
                
                while (balance > 0 && months < numPayments * 2) {
                    const interestPayment = balance * monthlyRate;
                    const principalPayment = testPayment - interestPayment;
                    
                    if (principalPayment <= 0) {
                        totalInterest = Infinity;
                        break;
                    }
                    
                    totalInterest += interestPayment;
                    balance -= principalPayment;
                    months++;
                    
                    if (balance <= 0) break;
                }
                
                if (Math.abs(totalInterest - targetTotalInterest) < 100) {
                    requiredExtraPayment = testExtra;
                    break;
                } else if (totalInterest > targetTotalInterest) {
                    // Need higher payment to reduce interest
                    low = testExtra;
                } else {
                    // Payment is too high
                    high = testExtra;
                }
                
                requiredExtraPayment = testExtra;
                iterations++;
            }
            
            // Check if target is achievable
            const maxExtraPayment = parseFloat(document.getElementById('extraPayment').max) || 3000;
            
            if (requiredExtraPayment >= loanAmount || iterations >= maxIterations) {
                document.getElementById('targetRateWarning').style.display = 'block';
                document.getElementById('targetRateWarning').style.background = '#fff3cd';
                document.getElementById('targetRateWarning').style.borderLeft = '3px solid #ffc107';
                document.getElementById('targetRateWarning').querySelector('span').innerHTML = 
                    '‚ö†Ô∏è Target rate is too low to achieve with reasonable monthly payments. Try a higher target rate.';
                document.getElementById('targetRateWarning').querySelector('span').style.color = '#856404';
                return;
            }
            
            if (requiredExtraPayment > maxExtraPayment) {
                document.getElementById('targetRateWarning').style.display = 'block';
                document.getElementById('targetRateWarning').style.background = '#fff3cd';
                document.getElementById('targetRateWarning').style.borderLeft = '3px solid #ffc107';
                document.getElementById('targetRateWarning').querySelector('span').innerHTML = 
                    `‚ö†Ô∏è Required extra payment ($${Math.round(requiredExtraPayment).toLocaleString()}) exceeds slider maximum. Increase the slider range or choose a higher target rate.`;
                document.getElementById('targetRateWarning').querySelector('span').style.color = '#856404';
                // Set to max and let user know
                document.getElementById('extraPayment').value = maxExtraPayment;
                document.getElementById('extraPaymentValue').textContent = '$' + Math.round(maxExtraPayment).toLocaleString();
            } else {
                // Update the extra payment slider to match the target
                const roundedExtra = Math.round(requiredExtraPayment / 50) * 50; // Round to nearest $50
                document.getElementById('extraPayment').value = roundedExtra;
                document.getElementById('extraPaymentValue').textContent = '$' + Math.round(roundedExtra).toLocaleString();
                document.getElementById('targetRateWarning').style.display = 'none';
            }
            
            // Recalculate with the new extra payment
            calculateEffectiveRate();
        }
        
        function copyToMortgageFields() {
            const monthlyPayment = parseFloat(document.getElementById('monthlyPaymentResult').textContent.replace(/[$,]/g, '')) || 0;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('mortgageInterestRate').value) || 0;
            
            // Copy to mortgage fields in main calculator
            document.getElementById('remainingBalance').value = loanAmount;
            document.getElementById('monthlyPayment').value = monthlyPayment;
            document.getElementById('mortgageRate').value = interestRate;
            
            // Enable mortgage checkbox
            document.getElementById('hasMortgage').checked = true;
            toggleMortgageFields();
            
            // Show confirmation
            alert('‚úÖ Mortgage details copied to calculator above!');
        }
        
        function updateSlider(type, value) {
            switch(type) {
                case 'appreciation':
                    document.getElementById('appreciationValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'futureAppreciation':
                    document.getElementById('futureAppreciationValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'rent':
                    document.getElementById('rentValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'investment':
                    document.getElementById('investmentValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'rentGrowth':
                    document.getElementById('rentGrowthValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'hoa':
                    document.getElementById('hoaValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'maintenance':
                    document.getElementById('maintenanceValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'propMgmt':
                    document.getElementById('propMgmtValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'taxes':
                    document.getElementById('taxesValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'insurance':
                    document.getElementById('insuranceValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'years':
                    document.getElementById('yearsValue').textContent = parseInt(value) + ' years';
                    break;
                case 'marginalTax':
                    document.getElementById('marginalTaxValue').textContent = parseInt(value) + '%';
                    break;
                case 'repairs':
                    document.getElementById('repairsValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'inspection':
                    document.getElementById('inspectionValue').textContent = '$' + parseInt(value).toLocaleString();
                    break;
                case 'commission':
                    document.getElementById('commissionValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'closing':
                    document.getElementById('closingValue').textContent = parseFloat(value).toFixed(1) + '%';
                    break;
                case 'investmentTax':
                    document.getElementById('investmentTaxValue').textContent = parseInt(value) + '%';
                    break;
                case 'capitalGains':
                    document.getElementById('capitalGainsValue').textContent = parseInt(value) + '%';
                    break;
            }
            updateCalculation();
        }
        
        function analyzeCrossovers(rentValues, sellValues) {
            const crossovers = [];
            let currentBetter = rentValues[0] > sellValues[0] ? 'rent' : 'sell';
            let segmentStart = 1;
            
            // Find all crossover points
            for (let i = 1; i < rentValues.length; i++) {
                const rentBetter = rentValues[i] > sellValues[i];
                const newBetter = rentBetter ? 'rent' : 'sell';
                
                if (newBetter !== currentBetter) {
                    // Crossover detected
                    crossovers.push({
                        better: currentBetter,
                        startYear: segmentStart,
                        endYear: i,
                        duration: i - segmentStart + 1
                    });
                    currentBetter = newBetter;
                    segmentStart = i + 1;
                }
            }
            
            // Add final segment
            crossovers.push({
                better: currentBetter,
                startYear: segmentStart,
                endYear: 30,
                duration: 30 - segmentStart + 1
            });
            
            // Generate recommendation text
            const finalRentValue = rentValues[rentValues.length - 1];
            const finalSellValue = sellValues[sellValues.length - 1];
            const finalDifference = Math.abs(finalRentValue - finalSellValue);
            const finalBetter = finalRentValue > finalSellValue ? 'RENT' : 'SELL';
            
            if (crossovers.length === 1) {
                // No crossovers - one strategy is always better
                const strategy = crossovers[0].better.toUpperCase();
                return `
                    üéØ RECOMMENDATION: ${strategy}<br>
                    ${strategy === 'RENT' ? 'Renting' : 'Selling'} is consistently better throughout all 30 years<br>
                    Final advantage: $${Math.round(finalDifference).toLocaleString()}
                `;
            } else {
                // Has crossovers - explain the pattern
                let explanation = `üéØ STRATEGY: `;
                
                if (crossovers.length === 2) {
                    const first = crossovers[0];
                    const second = crossovers[1];
                    if (first.better === 'rent') {
                        explanation += `RENT is better for ${first.duration} year${first.duration > 1 ? 's' : ''}, then SELL becomes better<br>`;
                    } else {
                        explanation += `SELL is better for ${first.duration} year${first.duration > 1 ? 's' : ''}, then RENT becomes better<br>`;
                    }
                    explanation += `Crossover at year ${second.startYear}. Final: ${finalBetter} by $${Math.round(finalDifference).toLocaleString()}`;
                } else {
                    // Multiple crossovers
                    explanation += `Multiple crossovers detected<br>`;
                    const segments = crossovers.slice(0, 2).map(seg => 
                        `${seg.better.toUpperCase()} (yrs ${seg.startYear}-${seg.endYear})`
                    ).join(', then ');
                    explanation += `${segments}...<br>Final: ${finalBetter} by $${Math.round(finalDifference).toLocaleString()}`;
                }
                
                return explanation;
            }
        }
        
        function updateCalculation() {
            // Get all values
            const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
            const originalPurchase = parseFloat(document.getElementById('originalPurchase').value) || 0;
            const futureAppreciation = parseFloat(document.getElementById('futureAppreciation').value) || 0;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const investmentReturn = parseFloat(document.getElementById('investmentReturn').value) || 0;
            const rentGrowth = parseFloat(document.getElementById('rentGrowth').value) || 0;
            const hoaFees = parseFloat(document.getElementById('hoaFees').value) || 0;
            const maintenance = parseFloat(document.getElementById('maintenance').value) || 0;
            const propManagement = parseFloat(document.getElementById('propManagement').value) || 0;
            const propertyTaxes = parseFloat(document.getElementById('propertyTaxes').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const capitalGainsRate = parseFloat(document.getElementById('capitalGainsRate').value) || 0;
            const marginalTaxRate = parseFloat(document.getElementById('marginalTaxRate').value) || 0;
            const depreciationBasis = parseFloat(document.getElementById('depreciationBasis').value) || currentValue;
            const selectedYear = parseInt(document.getElementById('analysisYears').value) || 30; // Selected year for display
            
            // New detailed selling costs
            const repairsCosts = parseFloat(document.getElementById('repairsCosts').value) || 0;
            const inspectionCosts = parseFloat(document.getElementById('inspectionCosts').value) || 0;
            const realtorCommission = parseFloat(document.getElementById('realtorCommission').value) || 0;
            const closingCosts = parseFloat(document.getElementById('closingCosts').value) || 0;
            const investmentTaxRate = parseFloat(document.getElementById('investmentTaxRate').value) || 0;
            
            // Mortgage variables
            const hasMortgage = document.getElementById('hasMortgage').checked;
            const remainingBalance = parseFloat(document.getElementById('remainingBalance').value) || 0;
            const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value) || 0;
            const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) || 0;
            
            // Calculate selling scenario
            const commissionCosts = currentValue * (realtorCommission / 100);
            const titleClosingCosts = currentValue * (closingCosts / 100);
            const totalSellingCosts = repairsCosts + inspectionCosts + commissionCosts + titleClosingCosts;
            const capitalGain = Math.max(0, currentValue - originalPurchase);
            const capitalGainsTax = capitalGain * (capitalGainsRate / 100);
            
            // Net proceeds after paying off mortgage (if any)
            const mortgagePayoff = hasMortgage ? remainingBalance : 0;
            const netProceeds = currentValue - totalSellingCosts - capitalGainsTax - mortgagePayoff;
            
            // Calculate projections for full 30 years (for chart)
            const years = Array.from({length: 30}, (_, i) => i + 1);
            const rentValues = [];
            const sellValues = [];

            for (let year = 1; year <= 30; year++) {
                // Rental scenario - future property value based on projected appreciation
                const futureValue = currentValue * Math.pow(1 + futureAppreciation / 100, year);
                
                // Calculate cumulative cash flow properly - sum of each year's net cash flow
                let cumulativeCashFlow = 0;
                const annualDepreciation = depreciationBasis / 27.5; // Residential rental depreciation
                
                for (let y = 1; y <= year; y++) {
                    const yearRent = monthlyRent * Math.pow(1 + rentGrowth / 100, y);
                    const yearPropMgmt = yearRent * (propManagement / 100);
                    const monthlyTaxes = propertyTaxes / 12;
                    const monthlyInsurance = insurance / 12;
                    const monthlyMortgage = hasMortgage ? monthlyPayment : 0;
                    const monthlyExpenses = hoaFees + maintenance + yearPropMgmt + monthlyTaxes + monthlyInsurance + monthlyMortgage;
                    const monthlyNet = yearRent - monthlyExpenses;
                    const yearlyNet = monthlyNet * 12;
                    
                    // Calculate rental income taxes (mortgage interest is deductible)
                    let mortgageInterestDeduction = 0;
                    if (hasMortgage && remainingBalance > 0) {
                        // Approximate mortgage interest for the year (simplified calculation)
                        mortgageInterestDeduction = remainingBalance * (mortgageRate / 100);
                    }
                    
                    const totalDeductibleExpenses = (hoaFees + maintenance + yearPropMgmt) * 12 + propertyTaxes + insurance + mortgageInterestDeduction;
                    const taxableIncome = Math.max(0, (yearRent * 12) - totalDeductibleExpenses - annualDepreciation);
                    const incomeTax = taxableIncome * (marginalTaxRate / 100);
                    
                    // Net cash flow after income taxes
                    const afterTaxNet = yearlyNet - incomeTax;
                    cumulativeCashFlow += afterTaxNet;
                }
                
                // Total rental value = property value + cash you've actually collected
                // This represents your total net worth from keeping the property
                const totalRentalValue = futureValue + cumulativeCashFlow;
                
                // Sell scenario - what your investment would be worth (after taxes)
                const grossInvestmentValue = netProceeds * Math.pow(1 + investmentReturn / 100, year);
                const investmentGain = grossInvestmentValue - netProceeds;
                const investmentTax = investmentGain * (investmentTaxRate / 100);
                const investmentValue = grossInvestmentValue - investmentTax;
                
                rentValues.push(totalRentalValue);
                sellValues.push(investmentValue);
            }
            
            // Update chart with full 30-year data but highlight selected year
            updateChart(years, rentValues, sellValues, selectedYear);
            
            // Update summary cards with selected year values
            const selectedRentValue = rentValues[selectedYear - 1];
            const selectedSellValue = sellValues[selectedYear - 1];
            const rentBetter = selectedRentValue > selectedSellValue;
            
            document.getElementById('rentTotal').textContent = '$' + Math.round(selectedRentValue).toLocaleString();
            document.getElementById('sellTotal').textContent = '$' + Math.round(selectedSellValue).toLocaleString();
            
            // Update card styling based on selected year
            if (rentBetter) {
                document.getElementById('rentCard').classList.add('better');
                document.getElementById('sellCard').classList.remove('better');
            } else {
                document.getElementById('sellCard').classList.add('better');
                document.getElementById('rentCard').classList.remove('better');
            }
            
            // Analyze crossover patterns for full 30 years
            const crossoverAnalysis = analyzeCrossovers(rentValues, sellValues);
            
            // Update recommendation with selected year context
            const difference = Math.abs(selectedRentValue - selectedSellValue);
            const recommendationEl = document.getElementById('recommendationText');
            const recommendationContainer = document.getElementById('recommendation');
            const betterOption = rentBetter ? 'RENT' : 'SELL';
            const recommendationClass = rentBetter ? 'rent-better' : 'sell-better';
            
            recommendationContainer.className = `recommendation ${recommendationClass}`;
            
            // Show selected year summary plus crossover analysis
            const yearSummary = `
                üéØ YEAR ${selectedYear}: ${betterOption}<br>
                Better by $${Math.round(difference).toLocaleString()}<br>
                <small style="opacity: 0.9;">${crossoverAnalysis.replace('üéØ STRATEGY: ', '').replace('üéØ RECOMMENDATION: ', '')}</small>
            `;
            
            recommendationEl.innerHTML = yearSummary;
        }
        
        function updateChart(years, rentValues, sellValues, highlightYear = 30) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Keep & Rent',
                        data: rentValues,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: years.map((year, index) => year === highlightYear ? 6 : 2),
                        pointHoverRadius: 5,
                        pointBackgroundColor: years.map((year, index) => year === highlightYear ? '#e74c3c' : '#27ae60'),
                        pointBorderColor: years.map((year, index) => year === highlightYear ? '#c0392b' : '#27ae60'),
                        pointBorderWidth: years.map((year, index) => year === highlightYear ? 3 : 1)
                    }, {
                        label: 'Sell & Invest',
                        data: sellValues,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: years.map((year, index) => year === highlightYear ? 6 : 2),
                        pointHoverRadius: 5,
                        pointBackgroundColor: years.map((year, index) => year === highlightYear ? '#e74c3c' : '#3498db'),
                        pointBorderColor: years.map((year, index) => year === highlightYear ? '#c0392b' : '#3498db'),
                        pointBorderWidth: years.map((year, index) => year === highlightYear ? 3 : 1)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                beforeBody: function(tooltipItems) {
                                    const rentValue = tooltipItems.find(item => item.datasetIndex === 0)?.raw || 0;
                                    const sellValue = tooltipItems.find(item => item.datasetIndex === 1)?.raw || 0;
                                    const difference = Math.abs(rentValue - sellValue);
                                    const betterOption = rentValue > sellValue ? 'Rent' : 'Sell';
                                    return `${betterOption} is better by $${Math.round(difference).toLocaleString()}`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: $${Math.round(value).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                maxTicksLimit: 31, // Show all years 1-30
                                callback: function(value, index) {
                                    // Show every 5th year plus year 1 and 30
                                    const year = this.getLabelForValue(value);
                                    if (year === 1 || year === 30 || year % 5 === 0) {
                                        return year;
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Value ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function renderStrategyCharts(strategyAData, strategyBData) {
            // Destroy existing charts if they exist
            if (strategyBalanceChart) {
                strategyBalanceChart.destroy();
            }
            if (strategyCostChart) {
                strategyCostChart.destroy();
            }

            // Render Balance Chart
            const balanceCtx = document.getElementById('strategyBalanceChart').getContext('2d');
            strategyBalanceChart = new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels: strategyAData.balanceMonths,
                    datasets: [
                        {
                            label: 'Strategy A: Larger Down Payment',
                            data: strategyAData.balances,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Strategy B: Extra Payments',
                            data: strategyBData.balances,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    const months = context[0].parsed.x;
                                    const years = Math.floor(months / 12);
                                    const remainingMonths = months % 12;
                                    return `Year ${years}${remainingMonths > 0 ? `, Month ${remainingMonths}` : ''}`;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + Math.round(context.parsed.y).toLocaleString();
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Months', font: { size: 11 } },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            title: { display: true, text: 'Balance ($)', font: { size: 11 } },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            // Render Cumulative Cost Chart
            const costCtx = document.getElementById('strategyCostChart').getContext('2d');
            strategyCostChart = new Chart(costCtx, {
                type: 'line',
                data: {
                    labels: strategyAData.costMonths,
                    datasets: [
                        {
                            label: 'Strategy A: Larger Down Payment',
                            data: strategyAData.cumulativeCosts,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            fill: true
                        },
                        {
                            label: 'Strategy B: Extra Payments',
                            data: strategyBData.cumulativeCosts,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    const months = context[0].parsed.x;
                                    const years = Math.floor(months / 12);
                                    const remainingMonths = months % 12;
                                    return `Year ${years}${remainingMonths > 0 ? `, Month ${remainingMonths}` : ''}`;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + Math.round(context.parsed.y).toLocaleString();
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Months', font: { size: 11 } },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            title: { display: true, text: 'Cumulative Cost (Today\'s $)', font: { size: 11 } },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateStrategyARateDisplay() {
            const rateAdjustment = parseFloat(document.getElementById('strategyARateAdjustment').value) || 0;
            const buydownCost = parseFloat(document.getElementById('strategyABuydownCost').value) || 0;
            const baseRate = parseFloat(document.getElementById('strategyInterestRate').value) || 0;
            const adjustedRate = baseRate + rateAdjustment;
            
            document.getElementById('strategyARateAdjustmentValue').textContent = rateAdjustment.toFixed(3) + '%';
            document.getElementById('strategyABuydownCostValue').textContent = '$' + Math.round(buydownCost).toLocaleString();
            document.getElementById('strategyAEffectiveRate').textContent = adjustedRate.toFixed(3) + '%';
            document.getElementById('strategyAEffectiveRateDisplay').textContent = adjustedRate.toFixed(3) + '%';
        }
        
        function updateStrategyBRateDisplay() {
            const rateAdjustment = parseFloat(document.getElementById('strategyBRateAdjustment').value) || 0;
            const buydownCost = parseFloat(document.getElementById('strategyBBuydownCost').value) || 0;
            const baseRate = parseFloat(document.getElementById('strategyInterestRate').value) || 0;
            const adjustedRate = baseRate + rateAdjustment;
            
            document.getElementById('strategyBRateAdjustmentValue').textContent = rateAdjustment.toFixed(3) + '%';
            document.getElementById('strategyBBuydownCostValue').textContent = '$' + Math.round(buydownCost).toLocaleString();
            document.getElementById('strategyBEffectiveRate').textContent = adjustedRate.toFixed(3) + '%';
            document.getElementById('strategyBEffectiveRateDisplay').textContent = adjustedRate.toFixed(3) + '%';
        }
        
        function updateInflationRateDisplay() {
            const inflationRate = parseFloat(document.getElementById('inflationRate').value) || 0;
            document.getElementById('inflationRateValue').textContent = inflationRate.toFixed(1) + '%';
        }
        
        function calculateStrategyEffectiveRate(principal, totalInterest, years) {
            // Calculate the effective rate using the actual interest paid and time period
            // This approximates what the annual rate would be if we paid this much interest
            // over this time period
            
            if (years <= 0 || principal <= 0) return 0;
            
            // Use iterative approach to find the rate that produces the observed interest
            let low = 0;
            let high = 20; // Max 20% rate for search
            let testRate = (low + high) / 2;
            const tolerance = 0.01; // 0.01% accuracy
            let iterations = 0;
            const maxIterations = 50;
            
            while (iterations < maxIterations && (high - low) > tolerance) {
                const monthlyRate = testRate / 100 / 12;
                const numPayments = years * 12;
                
                // Calculate what monthly payment would be needed at this rate
                const testPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                   (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                const testTotalInterest = (testPayment * numPayments) - principal;
                
                if (Math.abs(testTotalInterest - totalInterest) < 100) {
                    // Close enough
                    return testRate;
                } else if (testTotalInterest > totalInterest) {
                    // Test rate is too high
                    high = testRate;
                } else {
                    // Test rate is too low
                    low = testRate;
                }
                
                testRate = (low + high) / 2;
                iterations++;
            }
            
            return testRate;
        }

        function calculateStrategyComparison() {
            const homePrice = parseFloat(document.getElementById('strategyHomePrice').value) || 0;
            const interestRate = parseFloat(document.getElementById('strategyInterestRate').value) || 0;
            const loanTermYears = parseInt(document.getElementById('strategyLoanTerm').value) || 30;
            const availableCash = parseFloat(document.getElementById('availableCash').value) || 0;
            const baseDownPayment = parseFloat(document.getElementById('baseDownPayment').value) || 0;
            const inflationRate = parseFloat(document.getElementById('inflationRate').value) || 3.0;
            
            if (homePrice <= 0 || interestRate <= 0 || availableCash <= 0) {
                // Reset all displays
                document.getElementById('strategyADownPayment').textContent = '$0';
                document.getElementById('strategyALoanAmount').textContent = '$0';
                document.getElementById('strategyAMonthlyPayment').textContent = '$0';
                document.getElementById('strategyADownPercent').textContent = '0%';
                document.getElementById('strategyATotalInterest').textContent = '$0';
                document.getElementById('strategyATotalPayments').textContent = '$0';
                document.getElementById('strategyATotalCost').textContent = '$0';
                document.getElementById('strategyATotalCostReal').textContent = '$0';
                
                document.getElementById('strategyBDownPayment').textContent = '$0';
                document.getElementById('strategyBLoanAmount').textContent = '$0';
                document.getElementById('strategyBBasePayment').textContent = '$0';
                document.getElementById('strategyBExtraPayment').textContent = '$0';
                document.getElementById('strategyBTotalPayment').textContent = '$0';
                document.getElementById('strategyBTotalInterest').textContent = '$0';
                document.getElementById('strategyBPayoffTime').textContent = '0 years';
                document.getElementById('strategyBTotalCost').textContent = '$0';
                document.getElementById('strategyBTotalCostReal').textContent = '$0';
                
                document.getElementById('interestDifference').textContent = '$0';
                document.getElementById('totalCostDifference').textContent = '$0';
                document.getElementById('realCostDifference').textContent = '$0';
                document.getElementById('inflationImpact').textContent = '$0';
                document.getElementById('strategyRecommendation').innerHTML = 'Enter values to see recommendation';
                return;
            }
            
            // Get individual rate adjustments and buydown costs
            const strategyARateAdjustment = parseFloat(document.getElementById('strategyARateAdjustment').value) || 0;
            const strategyABuydownCost = parseFloat(document.getElementById('strategyABuydownCost').value) || 0;
            const strategyBRateAdjustment = parseFloat(document.getElementById('strategyBRateAdjustment').value) || 0;
            const strategyBBuydownCost = parseFloat(document.getElementById('strategyBBuydownCost').value) || 0;
            
            // Calculate adjusted rates for each strategy
            const strategyARate = interestRate + strategyARateAdjustment;
            const strategyBRate = interestRate + strategyBRateAdjustment;
            
            const strategyAMonthlyRate = strategyARate / 100 / 12;
            const strategyBMonthlyRate = strategyBRate / 100 / 12;
            const numPayments = loanTermYears * 12;
            
            // Update displayed effective rates
            updateStrategyARateDisplay();
            updateStrategyBRateDisplay();
            
            // Helper function to calculate present value of future payment
            function presentValue(futureValue, month, annualInflationRate) {
                const monthlyInflation = annualInflationRate / 100 / 12;
                return futureValue / Math.pow(1 + monthlyInflation, month);
            }
            
            // Strategy A: Larger down payment (buydown cost reduces available cash)
            const strategyAAvailableCash = Math.max(0, availableCash - strategyABuydownCost);
            const strategyADownPayment = baseDownPayment + strategyAAvailableCash;
            const strategyALoanAmount = homePrice - strategyADownPayment;
            const strategyADownPercent = (strategyADownPayment / homePrice) * 100;
            
            // Calculate monthly payment for Strategy A
            const strategyAMonthlyPayment = strategyALoanAmount * (strategyAMonthlyRate * Math.pow(1 + strategyAMonthlyRate, numPayments)) / 
                                          (Math.pow(1 + strategyAMonthlyRate, numPayments) - 1);
            const strategyATotalPayments = strategyAMonthlyPayment * numPayments;
            const strategyATotalInterest = strategyATotalPayments - strategyALoanAmount;
            const strategyATotalCost = strategyADownPayment + strategyATotalPayments + strategyABuydownCost;
            
            // Calculate inflation-adjusted cost for Strategy A and collect chart data
            let strategyARealCost = strategyADownPayment + strategyABuydownCost; // Down payment and buydown cost are paid today
            let strategyABalanceData = [];
            let strategyACostData = [];
            let balanceA = strategyALoanAmount;
            let cumulativeCostA = strategyADownPayment + strategyABuydownCost;
            
            strategyABalanceData.push(balanceA);
            strategyACostData.push(cumulativeCostA);
            
            for (let month = 1; month <= numPayments; month++) {
                const realPayment = presentValue(strategyAMonthlyPayment, month, inflationRate);
                strategyARealCost += realPayment;
                cumulativeCostA += realPayment;
                
                // Calculate remaining balance
                const interestPayment = balanceA * strategyAMonthlyRate;
                const principalPayment = strategyAMonthlyPayment - interestPayment;
                balanceA -= principalPayment;
                
                // Store data points every 3 months to reduce chart density
                if (month % 3 === 0 || month === numPayments) {
                    strategyABalanceData.push(Math.max(0, balanceA));
                    strategyACostData.push(cumulativeCostA);
                }
            }
            
            // Strategy B: Base down payment + extra monthly payments (buydown cost reduces available cash)
            const strategyBAvailableCash = Math.max(0, availableCash - strategyBBuydownCost);
            const strategyBDownPayment = baseDownPayment;
            const strategyBLoanAmount = homePrice - strategyBDownPayment;
            const strategyBBasePayment = strategyBLoanAmount * (strategyBMonthlyRate * Math.pow(1 + strategyBMonthlyRate, numPayments)) / 
                                       (Math.pow(1 + strategyBMonthlyRate, numPayments) - 1);
            
            // Calculate extra payment: spread available cash over the loan term
            const strategyBExtraPayment = strategyBAvailableCash / numPayments;
            const strategyBTotalMonthlyPayment = strategyBBasePayment + strategyBExtraPayment;
            
            // Simulate Strategy B loan payoff with extra payments and collect chart data
            let balance = strategyBLoanAmount;
            let totalInterestB = 0;
            let monthsB = 0;
            let monthlyPayments = [];
            let strategyBBalanceData = [balance];
            let strategyBCostData = [strategyBDownPayment + strategyBBuydownCost];
            let cumulativeCostB = strategyBDownPayment + strategyBBuydownCost;
            
            while (balance > 0 && monthsB < numPayments * 2) { // Safety limit
                monthsB++;
                const interestPayment = balance * strategyBMonthlyRate;
                const principalPayment = strategyBTotalMonthlyPayment - interestPayment;
                
                if (principalPayment <= 0) break;
                
                totalInterestB += interestPayment;
                balance -= principalPayment;
                monthlyPayments.push(strategyBTotalMonthlyPayment);
                
                const realPayment = presentValue(strategyBTotalMonthlyPayment, monthsB, inflationRate);
                cumulativeCostB += realPayment;
                
                // Store data points every 3 months to reduce chart density
                if (monthsB % 3 === 0 || balance <= 0) {
                    strategyBBalanceData.push(Math.max(0, balance));
                    strategyBCostData.push(cumulativeCostB);
                }
                
                if (balance <= 0) break;
            }
            
            const strategyBTotalCost = strategyBDownPayment + (strategyBTotalMonthlyPayment * monthsB) + strategyBBuydownCost;
            
            // Calculate effective interest rate for Strategy B considering the extra payments
            // The effective rate shows what the actual borrowing cost becomes with extra payments
            const strategyBEffectiveRate = calculateStrategyEffectiveRate(strategyBLoanAmount, totalInterestB, loanTermYears);
            
            // Calculate inflation-adjusted cost for Strategy B
            let strategyBRealCost = cumulativeCostB; // Already calculated during simulation
            
            // Create month labels for charts
            const maxMonths = Math.max(numPayments, monthsB);
            const strategyAMonths = [];
            const strategyBMonths = [];
            
            // Generate month labels for Strategy A
            for (let i = 0; i <= numPayments; i += 3) {
                strategyAMonths.push(i);
            }
            if (strategyAMonths[strategyAMonths.length - 1] !== numPayments) {
                strategyAMonths.push(numPayments);
            }
            
            // Generate month labels for Strategy B
            for (let i = 0; i <= monthsB; i += 3) {
                strategyBMonths.push(i);
            }
            if (strategyBMonths[strategyBMonths.length - 1] !== monthsB) {
                strategyBMonths.push(monthsB);
            }
            
            // Normalize data arrays to have the same length for charting
            const chartMonths = [];
            for (let i = 0; i <= maxMonths; i += 3) {
                chartMonths.push(i);
            }
            
            // Pad Strategy A data if Strategy B takes longer
            while (strategyABalanceData.length < strategyBBalanceData.length) {
                strategyABalanceData.push(0);
                strategyACostData.push(strategyACostData[strategyACostData.length - 1]);
            }
            
            // Pad Strategy B data if Strategy A takes longer
            while (strategyBBalanceData.length < strategyABalanceData.length) {
                strategyBBalanceData.push(0);
                strategyBCostData.push(strategyBCostData[strategyBCostData.length - 1]);
            }
            
            // Update Strategy A displays
            document.getElementById('strategyADownPayment').textContent = '$' + Math.round(strategyADownPayment).toLocaleString();
            document.getElementById('strategyALoanAmount').textContent = '$' + Math.round(strategyALoanAmount).toLocaleString();
            document.getElementById('strategyABasePayment').textContent = '$' + Math.round(strategyAMonthlyPayment).toLocaleString();
            document.getElementById('strategyAExtraPayment').textContent = '$0';
            document.getElementById('strategyATotalPayment').textContent = '$' + Math.round(strategyAMonthlyPayment).toLocaleString();
            document.getElementById('strategyATotalInterest').textContent = '$' + Math.round(strategyATotalInterest).toLocaleString();
            document.getElementById('strategyATotalPayments').textContent = '$' + Math.round(strategyATotalPayments).toLocaleString();
            document.getElementById('strategyATotalCost').textContent = '$' + Math.round(strategyATotalCost).toLocaleString();
            document.getElementById('strategyATotalCostReal').textContent = '$' + Math.round(strategyARealCost).toLocaleString();
            document.getElementById('strategyAActualEffectiveRate').textContent = strategyARate.toFixed(2) + '%';
            
            // Update Strategy B displays
            document.getElementById('strategyBDownPayment').textContent = '$' + Math.round(strategyBDownPayment).toLocaleString();
            document.getElementById('strategyBLoanAmount').textContent = '$' + Math.round(strategyBLoanAmount).toLocaleString();
            document.getElementById('strategyBBasePayment').textContent = '$' + Math.round(strategyBBasePayment).toLocaleString();
            document.getElementById('strategyBExtraPayment').textContent = '$' + Math.round(strategyBExtraPayment).toLocaleString();
            document.getElementById('strategyBTotalPayment').textContent = '$' + Math.round(strategyBTotalMonthlyPayment).toLocaleString();
            document.getElementById('strategyBTotalInterest').textContent = '$' + Math.round(totalInterestB).toLocaleString();
            document.getElementById('strategyBPayoffTime').textContent = formatMonthsToYears(monthsB);
            document.getElementById('strategyBTotalCost').textContent = '$' + Math.round(strategyBTotalCost).toLocaleString();
            document.getElementById('strategyBTotalCostReal').textContent = '$' + Math.round(strategyBRealCost).toLocaleString();
            document.getElementById('strategyBActualEffectiveRate').textContent = strategyBEffectiveRate.toFixed(2) + '%';
            
            // Calculate differences
            const interestDiff = strategyATotalInterest - totalInterestB;
            const totalCostDiff = strategyATotalCost - strategyBTotalCost;
            const realCostDiff = strategyARealCost - strategyBRealCost;
            const inflationImpact = totalCostDiff - realCostDiff;
            
            // Update comparison displays
            document.getElementById('interestDifference').textContent = '$' + Math.round(Math.abs(interestDiff)).toLocaleString();
            document.getElementById('interestDifferenceNote').textContent = interestDiff > 0 ? 'Strategy B saves interest' : 'Strategy A saves interest';
            document.getElementById('interestDifferenceNote').style.color = interestDiff > 0 ? '#27ae60' : '#e74c3c';
            
            document.getElementById('totalCostDifference').textContent = '$' + Math.round(Math.abs(totalCostDiff)).toLocaleString();
            document.getElementById('totalCostDifferenceNote').textContent = totalCostDiff > 0 ? 'Strategy B costs less' : 'Strategy A costs less';
            document.getElementById('totalCostDifferenceNote').style.color = totalCostDiff > 0 ? '#27ae60' : '#e74c3c';
            
            document.getElementById('realCostDifference').textContent = '$' + Math.round(Math.abs(realCostDiff)).toLocaleString();
            document.getElementById('realCostDifferenceNote').textContent = realCostDiff > 0 ? 'Strategy B costs less' : 'Strategy A costs less';
            document.getElementById('realCostDifferenceNote').style.color = realCostDiff > 0 ? '#27ae60' : '#e74c3c';
            
            document.getElementById('inflationImpact').textContent = '$' + Math.round(Math.abs(inflationImpact)).toLocaleString();
            document.getElementById('inflationImpactNote').textContent = 'Inflation reduces real cost difference';
            document.getElementById('inflationImpactNote').style.color = '#f39c12';
            
            // Generate recommendation based on real cost difference
            const recommendationEl = document.getElementById('strategyRecommendation');
            if (Math.abs(realCostDiff) < 1000) {
                recommendationEl.innerHTML = '‚öñÔ∏è STRATEGIES ARE NEARLY EQUAL (Real Cost)<br><small>Difference less than $1,000 in today\'s purchasing power</small>';
                recommendationEl.style.background = '#f39c12';
                recommendationEl.style.color = 'white';
            } else if (realCostDiff > 0) {
                recommendationEl.innerHTML = `üéØ STRATEGY B: Extra Payments<br><small>Saves $${Math.round(realCostDiff).toLocaleString()} in today's purchasing power</small>`;
                recommendationEl.style.background = '#27ae60';
                recommendationEl.style.color = 'white';
            } else {
                recommendationEl.innerHTML = `üéØ STRATEGY A: Larger Down Payment<br><small>Saves $${Math.round(Math.abs(realCostDiff)).toLocaleString()} in today's purchasing power</small>`;
                recommendationEl.style.background = '#e74c3c';
                recommendationEl.style.color = 'white';
            }
            
            // Render the comparison charts
            renderStrategyCharts(
                {
                    balanceMonths: chartMonths,
                    balances: strategyABalanceData,
                    costMonths: chartMonths,
                    cumulativeCosts: strategyACostData
                },
                {
                    balanceMonths: chartMonths,
                    balances: strategyBBalanceData,
                    costMonths: chartMonths,
                    cumulativeCosts: strategyBCostData
                }
            );
        }
        
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        // Initialize on page load
        window.onload = function() {
            updateAppreciationFromValues(); // Calculate and set appreciation rate first
            calculateMortgage(); // Initialize mortgage calculator and effective rate
            calculateStrategyComparison(); // Initialize strategy comparison
        };
    </script>
    </div>
</body>
</html>